/* 1)
 Получить статистику по дням. 
 Просто посчитать число всех событий по дням, число показов, число кликов, 
 число уникальных объявлений и уникальных кампаний.
   */

--Группируем по дням и считаем число событий в разрезе одного дня
select date, count(*) as events_count from default.ads_data ad 
group by date

-- Аналогично сичтаем показы
select date, count(*) as views from default.ads_data ad 
where event = 'view'
group by date

-- Аналогично для кликов
select date, count(*) as views from default.ads_data ad 
where event = 'click'
group by date


/* 2)
Разобраться, почему случился такой скачок 2019-04-05? 
Каких событий стало больше? У всех объявлений или только у некоторых?
*/
select date, sum(target_audience_count) as audience from default.ads_data ad 
group by date
--Очевидно, что скачок не обусловлен суммарным охватом аудитории

select date, ad_id, count(*) as views from default.ads_data ad 
--where event = 'view'
group by date,ad_id
order by views desc
limit 10

select ad_id, count(*) as views from default.ads_data ad 
where event = 'view' and date='2019-04-05'
group by ad_id
order by views desc
limit 10
--Резко отличается число показов объявления с ad_id = 112 583

select ad_id, count(*) as clicks from default.ads_data ad 
where event = 'click' and date='2019-04-05'
group by ad_id
order by clicks desc
limit 10
-- Число кликов отличается еще сильнее, чем число показов. Таким образом можно сделать вывод, что
-- объявление с ad_id = 112 583 было очень удачным в плане конверсии 

select count(*), date from default.ads_data ad 
where ad_id=112583
group by date
-- Объявление с ad_id = 112 583 первый раз появляется 2019-04-05, таким образом скачок событий в 
-- этот день связан с данным обяъвлением.


/* 4)
 Похоже, в наших логах есть баг, объявления приходят с кликами, 
 но без показов! Сколько таких объявлений, есть ли какие-то закономерности? 
 Эта проблема наблюдается на всех платформах?
 */
--В запросе выберем айди сообщений у которых был клик, 
-- но которые не попадают в результаты подзапроса.
select ad_id, platform from default.ads_data ad 
where event='click'
and ad_id not in ( 
--в подзапросе выбираем все айди сообщений с показами
select ad_id from default.ads_data ad 
where event='view'
)

--Посчитаем количество таких сообщений
select count(*) from default.ads_data ad 
where event='click'
and ad_id not in ( 
select ad_id from default.ads_data ad 
where event='view'
)
-- Таких сообщений 89 штук

--Посмотрим по платформам
select distinct platform from default.ads_data ad 
where event='click'
and ad_id not in ( 
select ad_id from default.ads_data ad 
where event='view'
)
-- Баг наблюдается на всех платформах

--Проверим закономерности
select date, time, ad_id, client_union_id, campaign_union_id from default.ads_data ad 
where event='click'
and ad_id not in ( 
select ad_id from default.ads_data ad 
where event='view'
)
--Основная часть багов наблюдается в первый день и немного во второй ранним утром. Возможно,
--это связано с запуском платформы. Потом данную проблему удалось исправить.